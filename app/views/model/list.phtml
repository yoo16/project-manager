<? include('_header.phtml') ?>

<? include('add_window.phtml'); ?>

<div class="alert alert-success">
  <h3>Models</h3>
  <ul>
    <li>if you 'Import from DB', will automatically add model's information for O/R mapping from PostgreSQL.</li>
    <li>if you 'Add', create model's information on 'project-manager' and create table on PostgreSQL.</li>
    <li>Model's name by plural form is recommended.</li>
    <li>When table is created, will automatically add columns. * id, created_at, updated_at, sort_order</li>
    <li>When you click 'PHP Export', PHP model's file(O/R map) to local path specified. * your_project_dir(php-work)/app/models/</li>
    <li>You can generate PHP controller files by models.</li>
  </ul>
</div>

<div class="">
  <div class="pt-3">
    <form action="<?= url_for('project/sync_db') ?>" method="post" class="">
      <?= FormHelper::linkModal('#add-window', LABEL_ADD) ?>
      <?= FormHelper::submit('Import from DB', ['class' => 'btn btn-outline-primary confirm-dialog', 'message' => 'Dou you import from DB?']) ?>
      <?= FormHelper::hidden('project_id', $this->project->value['id']) ?>
      <?= FormHelper::linkButton('lock', 'Lock', null ,['class' => 'btn btn-outline-primary confirm-dialog', 'message' => 'Dou you lock models?']) ?>
      <?= FormHelper::link('document/list', 'Document', null ,['class' => 'btn btn-outline-primary']) ?>
    </form>
  </div>

  <table class="table">
    <thead class="thead-default">
      <tr>
        <th></th>
        <th>Name</th>
        <th></th>
        <th>
          <div>Entity</div>
          <div>Class</div>
        </th>
        <th>Controller</th>
        <th>DB info</th>
      </tr>
    </thead>

    <? if ($this->model->values): ?>
    <? foreach ($this->model->values as $model): ?>
    <tr>
      <td><?= FormHelper::linkButton('edit', LABEL_EDIT, $model['id']) ?></td>
      <td>
        <div><?= FormHelper::link('attribute/', $model['name'], ['model_id' => $model['id']]) ?></div>
        <div><?= $model['label'] ?></div>
        <? if ($model['old_name']): ?><div>(<?= $model['old_name'] ?> : <?= $model['old_database_id'] ?>)</div><? endif ?>
      </td>
      <td><a class="btn btn-outline-primary" href="<?= url_for('values', $model['id']) ?>">Data</a></td>
      <td>
        <div><?= $model['entity_name'] ?></div>
        <div><?= $model['class_name'] ?></div>
      </td>
      <td>
        <form action="<?= url_for('page/create_page_from_model') ?>" method="post">
          <?= FormHelper::button(LABEL_CREATE, ['class' => 'btn btn-sm btn-primary confirm-dialog', 'message' => "Create page?"]) ?>
          <?= FormHelper::hidden('model_id', $model['id']) ?>
        </form>
      </td>
      <td>
        <? if ($model['pg_class']): ?>
        <?= FormHelper::badgeTag($model['pg_class']['pg_class_id']) ?>
      <? else: ?>
      <form action="<?= url_for('add_table') ?>" method="post">
        <?= FormHelper::submit(LABEL_ADD, ['class' => 'btn btn-primary btn-sm']) ?>
        <?= FormHelper::hidden('model_id', $model['id']) ?>
      </form>
    <? endif ?>

    <? if ($model['pg_class_id'] == $model['pg_class']['pg_class_id']): ?>
    <?= FormHelper::badgeTag('sync', null, 'success') ?>
  <? else: ?>
  <?= FormHelper::badgeTag('unsync', null, 'danger') ?>
<? endif ?>

<? if ($model['label'] == $model['pg_class']['comment']): ?>
<?= FormHelper::badgeTag('label', null, 'success') ?>
<? else: ?>
<?= FormHelper::badgeTag('different label', null, 'danger') ?>
<?= FormHelper::badgeTag($model['pg_class']['comment'], null, 'default') ?>
<? endif ?>
<? if ($model['is_lock']): ?>
<?= FormHelper::badgeTag('Delete Lock', null, 'danger') ?>
<? endif ?>
</td>

</tr>
<? endforeach ?>
<? endif ?>
</table>
</div>
